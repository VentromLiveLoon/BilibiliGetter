#!/bin/python

# url='https://www.bilibili.com/video/BV15K4y1Q7vL/?spm_id_from=333.1007.top_right_bar_window_custom_collection.content.click&vd_source=d6a2c7236ac768f11e6fe146a6f1a009'
from time import sleep

#输入和初始化部分
url=input("请输入视频的url：：");

from selenium import webdriver;
from selenium.webdriver.common.by import By;
from selenium.webdriver.chrome.options import Options;
from readCookies import readCookies;
import re;


# 设置浏览器为无头模式
ch_options=Options();
ch_options.add_argument('--headless');
browser = webdriver.Chrome(options=ch_options);

#设置浏览器为有头模式
# browser = webdriver.Chrome();





# 登录刷新网页
browser.get(url=url);
name=browser.find_element(by=By.XPATH,value='//*[@id="viewbox_report"]/h1').text;
print(f"The title is::{name}");
name=name[:10];
sleep(1);

#设置bilibili的cookie
browser.delete_all_cookies();
cookies = readCookies();
for cookie in cookies:
    browser.add_cookie(cookie_dict=cookie);
browser.refresh();
# input("yes?");
sleep(1);


#获取video.m4s和audio.m4s的视频链接


#正则表达式初始化
find_url=re.compile(r'<script>(?P<video_url>.*?)</script>',re.S);
video_url=re.compile(r'"video":(?P<videos_quality>.*?),"baseUrl":"(?P<video_url>.*?)",',re.S);
#获取script中的源码
script=find_url.search(browser.page_source);
script_content=script.group('video_url');
#获取视频的链接，从script_content中获取视频的m4s和视频的质量。
videos_quality = video_url.search(script_content).group('videos_quality');
print();
print(f"The videos quality is {videos_quality}");
print();
video_url=video_url.search(script_content).group('video_url');


#正则表达式初始化
audio_url=re.compile(r'"audio":.*?{"id":.*?,"baseUrl":"(?P<audio_url>.*?)"',re.S);
#获取音频的m4s链接，从script_content获取
audio_url=audio_url.search(script_content).group('audio_url');




# 输出vedio.m4s和audio.m4s的视频和音频链接,并且保存在文件中
print(video_url);
with open('vidio_m4s','a') as file:
    file.write(video_url);
    file.write("\n");
print();
print(audio_url);
with open('audio_m4s','a') as file:
    file.write(audio_url);
    file.write("\n");
#关闭浏览器
browser.close();





# 视频下载部分
import requests;
import os;
# 请求头
header={
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.90 Safari/537.36',
        'Referer': 'https://www.bilibili.com/'
}

# 开始请求声音和视频
video_resp=requests.get(headers=header,url=video_url);
audio_resp=requests.get(headers=header,url=audio_url);

# 关闭请求
video_resp.close();
audio_resp.close();


# 保存请求的内容
with open(f"/home/windstorm/Videos/background/{name}.mp4",'wb') as file:
    file.write(video_resp.content);

with open(f"/home/windstorm/Music/{name}.mp4",'wb') as file:
    file.write(audio_resp.content);
# resp.encoding='utf-8';
# print(resp.text);


#开始合并视频和声音
os.system(f"ffmpeg -i /home/windstorm/Music/{name}.mp4 -i /home/windstorm/Videos/background/{name}.mp4 -c copy /home/windstorm/Videos/bilibili/{name}.mp4");


